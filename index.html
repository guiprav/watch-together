<!doctype html>
<meta charset="utf-8">
<title>Watch Together</title>
<script src="http://code.jquery.com/jquery-2.1.3.js"></script>
<script src="http://cdn.peerjs.com/0.3/peer.js"></script>
<script src="http://cdn.jsdelivr.net/lodash/3.6.0/lodash.js"></script>
<script>
	var target_peer_id;
	window.w2g = {
		ping_timeout: 10000
		, setup: function() {
			other_peer.on (
				'data', function(data) {
					var name = data[0];
					var message_arguments = data.slice(1);
					if(['ping', 'pong'].indexOf(name) === -1) {
						console.log("Message received:", name, message_arguments);
					}
					w2g.message_handlers[name].apply(null, message_arguments);
				}
			);
			setInterval (
				function() {
					var elapsed = performance.now() - other_peer.ping_timestamp;
					if(elapsed > w2g.ping_timeout) {
						console.log("Ping timed out after", elapsed + "ms.");
						w2g.ping();
					}
				}
				, 500
			);
			w2g.ping();
		}
		, quietly_play: function() {
			var $video = $('video');
			$video.data('quietly-play', true);
			$video[0].play();
		}
		, quietly_pause: function() {
			var $video = $('video');
			$video.data('quietly-pause', true);
			$video[0].pause();
		}
		, quietly_seek: function(target_time) {
			var $video = $('video');
			$video.data('quietly-seek', true);
			$video.prop('currentTime', target_time);
		}
		, peer_seek: function(target_time) {
			var $video = $('video');
			$video.data('peer-seek', true);
			$video.prop('currentTime', target_time);
		}
		, send: function(name) {
			var data = [].slice.call(arguments, 0);
			if(['ping', 'pong'].indexOf(name) === -1) {
				console.log("Message sent:", name, data.slice(1));
			}
			other_peer.send(data);
		}
		, ping: _.throttle (
			function() {
				if(!other_peer.ping_count) {
					other_peer.ping_count = 0;
				}
				other_peer.ping_timestamp = performance.now();
				w2g.send('ping', ++other_peer.ping_count, $('video').prop('currentTime'));
			}
			, 500
		)
		, adjust_peer_time: function(time) {
			if(other_peer.roundtrip) {
				time += other_peer.roundtrip / 2 / 1000;
			}
			return time;
		}
	};
	w2g.message_handlers = {
		file_selected: function(name) {
			$('.peers-file').text(name);
		}
		, play: function() {
			w2g.quietly_play();
		}
		, pause: function() {
			w2g.quietly_pause();
		}
		, seek: function(time) {
			w2g.peer_seek(w2g.adjust_peer_time(time));
		}
		, ping: function(ping_count, peer_time) {
			w2g.send('pong', ping_count);
			if(!other_peer.roundtrip) {
				w2g.ping();
			}
			if(peer_time !== null && peer_time !== other_peer.last_reported_time) {
				other_peer.last_reported_time = peer_time;
				peer_time = w2g.adjust_peer_time(peer_time);
				$('.peer-time').text(peer_time);
				$('.lag').text(peer_time - $('video').prop('currentTime'));
			}
		}
		, pong: function(ping_count) {
			if(ping_count < other_peer.ping_count) {
				return;
			}
			w2g.ping();
			other_peer.roundtrip = performance.now() - other_peer.ping_timestamp;
			$('.ping').text(Math.round(other_peer.roundtrip));
		}
	};
	window.peer = new Peer (
		prompt("Who are you?")
		, {
			key: 'w3y11gzechy6i529'
		}
	);
	window.other_peer = null;
	peer.on (
		'connection', function(other_peer) {
			window.other_peer = other_peer;
			w2g.setup();
			alert(other_peer.peer + " has joined you.");
		}
	);
	target_peer_id = prompt("Who's your peer? (Leave blank to wait for someone)");
	if(target_peer_id !== '') {
		window.other_peer = peer.connect(target_peer_id);
		other_peer.on (
			'open', function() {
				w2g.setup();
			}
		);
	}
</script>
<style>
	video
	{
		display: block;
		height: 720px;
		margin: 0 auto;
	}
</style>
<p>
	Your file:
	<input class="your-file" type="file" accept="video/*">
</p>
<p>
	Peer's file: <span class="peers-file">None</span>
</p>
<p>
	Peer's current playback time: <span class="peer-time">0</span>s
	(lag: <span class="lag">0</span>s)
</p>
<p>
	Ping: <span class="ping">0</span>ms
</p>
<video controls></video>
<script>
	var $your_file = $('.your-file');
	var $video = $('video');
	$your_file.change (
		function() {
			var file = this.files[0];
			document.querySelector('video').src = URL.createObjectURL(file);
			if(other_peer) {
				w2g.send('file_selected', file.name);
			}
		}
	);
	$video.on (
		'play', function(event) {
			if($video.data('quietly-play')) {
				$video.removeData('quietly-play');
				return;
			}
			if(other_peer) {
				w2g.send('play');
			}
		}
	);
	$video.on (
		'pause', function(event) {
			if($video.data('quietly-pause')) {
				$video.removeData('quietly-pause');
				return;
			}
			if(other_peer) {
				w2g.send('pause');
			}
		}
	);
	$video.on (
		'seeked', function(event) {
			if($video.data('quietly-seek')) {
				$video.removeData('quietly-seek');
				return;
			}
			if($video.data('peer-seek')) {
				$video.removeData('peer-seek');
				if(!$video.prop('paused')) {
					w2g.send('play');
				}
				return;
			}
			w2g.quietly_pause();
			w2g.send('seek', $video.prop('currentTime'));
		}
	);
</script>
